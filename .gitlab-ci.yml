#
# Generated by: hguild source:run Catalyst gitlabCIBuildYML
#
include:
    - template: Security/Secret-Detection.gitlab-ci.yml
    - template: Security/SAST.gitlab-ci.yml

variables:
    HGUILD_PROJECT_NAME: libWexpr
    HGUILD: _HGuild/Source/HGuild@master/Prefix/hguild
    HGUILD_GIT_USE_HTTPS: 1

.hguild_before_script: &hguild_before_script
    # Note: this is here instead of variables cause gitlab expands it oddly otherwise
    # We blank it out first to prevent upper files (read: osx's keychain helper) from taking over it
    - git config --global --replace-all credential.helper ''
    - git config --global --add credential.helper '!f() { sleep 1; echo "username=gitlab-ci-token\npassword=${CI_JOB_TOKEN}"; }; f'
    - curl -fsSL 'https://developer.i.hackerguild.com/HGuildCI/hguildCISetup.rb' | ruby -- -
    - ${HGUILD} packages:update

stages:
    - prepare
    - build
    - test
    - package




Linux-X86_64@Clang@@~Debug:Prepare:
    image: docker.i.hackerguild.com/hackerguild/hackerguild-gitlabci-docker:latest

    except:
      - schedules

    artifacts:
        paths:
        - _HGuild/Build/Linux-X86_64@Clang@@/Debug/${HGUILD_PROJECT_NAME}@CI
        
    cache:
        key: "Linux-X86_64@Clang@@~Debug"
        paths:
        - _HGuild/
    
    stage: prepare
    tags:
        - linux
        - docker
        - x86_64
        
    variables:
        HGUILD_PROFILE: Linux-X86_64@Clang@@
        HGUILD_BUILDTYPE: Debug

    before_script:
        - *hguild_before_script

    script:
        - ${HGUILD} install --buildType "${HGUILD_BUILDTYPE}" --profile "${HGUILD_PROFILE}" --customSourceDir . --dependenciesOnly ${HGUILD_PROJECT_NAME}@CI



Linux-X86_64@Clang@@~Debug:Build:
    image: docker.i.hackerguild.com/hackerguild/hackerguild-gitlabci-docker:latest

    except:
      - schedules

    needs:
      - Linux-X86_64@Clang@@~Debug:Prepare
    
    artifacts:
        paths:
        - _HGuild/Build/Linux-X86_64@Clang@@/Debug/${HGUILD_PROJECT_NAME}@CI
            
    cache:
        key: "Linux-X86_64@Clang@@~Debug"
        paths:
        - _HGuild/
 
    stage: build
    tags:
        - linux
        - docker
        - x86_64
        
    variables:
        HGUILD_PROFILE: Linux-X86_64@Clang@@
        HGUILD_BUILDTYPE: Debug

    before_script:
        - *hguild_before_script

    script:
        - ${HGUILD} install --buildType "${HGUILD_BUILDTYPE}" --profile "${HGUILD_PROFILE}" --customSourceDir . ${HGUILD_PROJECT_NAME}@CI
        # For at least eslint, it'll run as a different user, while the CI runs as root
        # thinlto.cache however doesnt allow read access to other users - adjust that just within CI
        - find _HGuild/Build/Linux-X86_64@Clang@@/Debug/${HGUILD_PROJECT_NAME}@CI -name 'thinlto.cache' -exec chmod -Rv o+rx '{}' ';'








Linux-X86_64@Clang@@~Debug:Package:
    image: docker.i.hackerguild.com/hackerguild/hackerguild-gitlabci-docker:latest
    only:
        - tags   # tags are stable
        - master # master branch we always want the newest ref
        # TODO? release branches. But we dont want to pickup issue branches.

    # package has no needs - requires everyone to finish the previous stages, and all tests to pass
    # we do want artifacts though from our build
    dependencies:
        - Linux-X86_64@Clang@@~Debug:Build
    except:
      - schedules

    artifacts:
        paths:
        - _HGuild/Build/Linux-X86_64@Clang@@/Debug/${HGUILD_PROJECT_NAME}@CI
            
    cache:
        key: "Linux-X86_64@Clang@@~Debug"
        paths:
        - _HGuild/
 
    stage: package
    tags:
        - linux
        - docker
        - x86_64
        
    variables:
        HGUILD_PROFILE: Linux-X86_64@Clang@@
        HGUILD_BUILDTYPE: Debug

    before_script:
        - *hguild_before_script

    script:
        - ${HGUILD} source:install:package --buildType "${HGUILD_BUILDTYPE}" --profile "${HGUILD_PROFILE}" --customSourceDir . ${HGUILD_PROJECT_NAME}@CI build.hguildpkg
        - curl -fsSL 'https://developer.i.hackerguild.com/HGuildCI/hguildCIUpload.rb' | ruby -- - "${HGUILD_PROJECT_NAME}" "${CI_COMMIT_REF_NAME}" "${HGUILD_PROFILE}" "${HGUILD_BUILDTYPE}" build.hguildpkg
        - rm build.hguildpkg




Linux-X86_64@Clang@@~Release:Prepare:
    image: docker.i.hackerguild.com/hackerguild/hackerguild-gitlabci-docker:latest

    except:
      - schedules

    artifacts:
        paths:
        - _HGuild/Build/Linux-X86_64@Clang@@/Release/${HGUILD_PROJECT_NAME}@CI
        
    cache:
        key: "Linux-X86_64@Clang@@~Release"
        paths:
        - _HGuild/
    
    stage: prepare
    tags:
        - linux
        - docker
        - x86_64
        
    variables:
        HGUILD_PROFILE: Linux-X86_64@Clang@@
        HGUILD_BUILDTYPE: Release

    before_script:
        - *hguild_before_script

    script:
        - ${HGUILD} install --buildType "${HGUILD_BUILDTYPE}" --profile "${HGUILD_PROFILE}" --customSourceDir . --dependenciesOnly ${HGUILD_PROJECT_NAME}@CI



Linux-X86_64@Clang@@~Release:Build:
    image: docker.i.hackerguild.com/hackerguild/hackerguild-gitlabci-docker:latest

    except:
      - schedules

    needs:
      - Linux-X86_64@Clang@@~Release:Prepare
    
    artifacts:
        paths:
        - _HGuild/Build/Linux-X86_64@Clang@@/Release/${HGUILD_PROJECT_NAME}@CI
            
    cache:
        key: "Linux-X86_64@Clang@@~Release"
        paths:
        - _HGuild/
 
    stage: build
    tags:
        - linux
        - docker
        - x86_64
        
    variables:
        HGUILD_PROFILE: Linux-X86_64@Clang@@
        HGUILD_BUILDTYPE: Release

    before_script:
        - *hguild_before_script

    script:
        - ${HGUILD} install --buildType "${HGUILD_BUILDTYPE}" --profile "${HGUILD_PROFILE}" --customSourceDir . ${HGUILD_PROJECT_NAME}@CI
        # For at least eslint, it'll run as a different user, while the CI runs as root
        # thinlto.cache however doesnt allow read access to other users - adjust that just within CI
        - find _HGuild/Build/Linux-X86_64@Clang@@/Release/${HGUILD_PROJECT_NAME}@CI -name 'thinlto.cache' -exec chmod -Rv o+rx '{}' ';'








Linux-X86_64@Clang@@~Release:Package:
    image: docker.i.hackerguild.com/hackerguild/hackerguild-gitlabci-docker:latest
    only:
        - tags   # tags are stable
        - master # master branch we always want the newest ref
        # TODO? release branches. But we dont want to pickup issue branches.

    # package has no needs - requires everyone to finish the previous stages, and all tests to pass
    # we do want artifacts though from our build
    dependencies:
        - Linux-X86_64@Clang@@~Release:Build
    except:
      - schedules

    artifacts:
        paths:
        - _HGuild/Build/Linux-X86_64@Clang@@/Release/${HGUILD_PROJECT_NAME}@CI
            
    cache:
        key: "Linux-X86_64@Clang@@~Release"
        paths:
        - _HGuild/
 
    stage: package
    tags:
        - linux
        - docker
        - x86_64
        
    variables:
        HGUILD_PROFILE: Linux-X86_64@Clang@@
        HGUILD_BUILDTYPE: Release

    before_script:
        - *hguild_before_script

    script:
        - ${HGUILD} source:install:package --buildType "${HGUILD_BUILDTYPE}" --profile "${HGUILD_PROFILE}" --customSourceDir . ${HGUILD_PROJECT_NAME}@CI build.hguildpkg
        - curl -fsSL 'https://developer.i.hackerguild.com/HGuildCI/hguildCIUpload.rb' | ruby -- - "${HGUILD_PROJECT_NAME}" "${CI_COMMIT_REF_NAME}" "${HGUILD_PROFILE}" "${HGUILD_BUILDTYPE}" build.hguildpkg
        - rm build.hguildpkg




macOS-ARM64@Clang@@~Debug:Prepare:

    except:
      - schedules

    artifacts:
        paths:
        - _HGuild/Build/macOS-ARM64@Clang@@/Debug/${HGUILD_PROJECT_NAME}@CI
        
    cache:
        key: "macOS-ARM64@Clang@@~Debug"
        paths:
        - _HGuild/
    
    stage: prepare
    tags:
        - ninja
        - osx
        - clang
        - arm64
        
    variables:
        HGUILD_PROFILE: macOS-ARM64@Clang@@
        HGUILD_BUILDTYPE: Debug

    before_script:
        - *hguild_before_script

    script:
        - ${HGUILD} install --buildType "${HGUILD_BUILDTYPE}" --profile "${HGUILD_PROFILE}" --customSourceDir . --dependenciesOnly ${HGUILD_PROJECT_NAME}@CI



macOS-ARM64@Clang@@~Debug:Build:

    except:
      - schedules

    needs:
      - macOS-ARM64@Clang@@~Debug:Prepare
    
    artifacts:
        paths:
        - _HGuild/Build/macOS-ARM64@Clang@@/Debug/${HGUILD_PROJECT_NAME}@CI
            
    cache:
        key: "macOS-ARM64@Clang@@~Debug"
        paths:
        - _HGuild/
 
    stage: build
    tags:
        - ninja
        - osx
        - clang
        - arm64
        
    variables:
        HGUILD_PROFILE: macOS-ARM64@Clang@@
        HGUILD_BUILDTYPE: Debug

    before_script:
        - *hguild_before_script

    script:
        - ${HGUILD} install --buildType "${HGUILD_BUILDTYPE}" --profile "${HGUILD_PROFILE}" --customSourceDir . ${HGUILD_PROJECT_NAME}@CI
        # For at least eslint, it'll run as a different user, while the CI runs as root
        # thinlto.cache however doesnt allow read access to other users - adjust that just within CI
        - find _HGuild/Build/macOS-ARM64@Clang@@/Debug/${HGUILD_PROJECT_NAME}@CI -name 'thinlto.cache' -exec chmod -Rv o+rx '{}' ';'








macOS-ARM64@Clang@@~Debug:Package:
    only:
        - tags   # tags are stable
        - master # master branch we always want the newest ref
        # TODO? release branches. But we dont want to pickup issue branches.

    # package has no needs - requires everyone to finish the previous stages, and all tests to pass
    # we do want artifacts though from our build
    dependencies:
        - macOS-ARM64@Clang@@~Debug:Build
    except:
      - schedules

    artifacts:
        paths:
        - _HGuild/Build/macOS-ARM64@Clang@@/Debug/${HGUILD_PROJECT_NAME}@CI
            
    cache:
        key: "macOS-ARM64@Clang@@~Debug"
        paths:
        - _HGuild/
 
    stage: package
    tags:
        - ninja
        - osx
        - clang
        - arm64
        
    variables:
        HGUILD_PROFILE: macOS-ARM64@Clang@@
        HGUILD_BUILDTYPE: Debug

    before_script:
        - *hguild_before_script

    script:
        - ${HGUILD} source:install:package --buildType "${HGUILD_BUILDTYPE}" --profile "${HGUILD_PROFILE}" --customSourceDir . ${HGUILD_PROJECT_NAME}@CI build.hguildpkg
        - curl -fsSL 'https://developer.i.hackerguild.com/HGuildCI/hguildCIUpload.rb' | ruby -- - "${HGUILD_PROJECT_NAME}" "${CI_COMMIT_REF_NAME}" "${HGUILD_PROFILE}" "${HGUILD_BUILDTYPE}" build.hguildpkg
        - rm build.hguildpkg




macOS-ARM64@Clang@@~RelWithDebInfo:Prepare:

    except:
      - schedules

    artifacts:
        paths:
        - _HGuild/Build/macOS-ARM64@Clang@@/RelWithDebInfo/${HGUILD_PROJECT_NAME}@CI
        
    cache:
        key: "macOS-ARM64@Clang@@~RelWithDebInfo"
        paths:
        - _HGuild/
    
    stage: prepare
    tags:
        - ninja
        - osx
        - clang
        - arm64
        
    variables:
        HGUILD_PROFILE: macOS-ARM64@Clang@@
        HGUILD_BUILDTYPE: RelWithDebInfo

    before_script:
        - *hguild_before_script

    script:
        - ${HGUILD} install --buildType "${HGUILD_BUILDTYPE}" --profile "${HGUILD_PROFILE}" --customSourceDir . --dependenciesOnly ${HGUILD_PROJECT_NAME}@CI



macOS-ARM64@Clang@@~RelWithDebInfo:Build:

    except:
      - schedules

    needs:
      - macOS-ARM64@Clang@@~RelWithDebInfo:Prepare
    
    artifacts:
        paths:
        - _HGuild/Build/macOS-ARM64@Clang@@/RelWithDebInfo/${HGUILD_PROJECT_NAME}@CI
            
    cache:
        key: "macOS-ARM64@Clang@@~RelWithDebInfo"
        paths:
        - _HGuild/
 
    stage: build
    tags:
        - ninja
        - osx
        - clang
        - arm64
        
    variables:
        HGUILD_PROFILE: macOS-ARM64@Clang@@
        HGUILD_BUILDTYPE: RelWithDebInfo

    before_script:
        - *hguild_before_script

    script:
        - ${HGUILD} install --buildType "${HGUILD_BUILDTYPE}" --profile "${HGUILD_PROFILE}" --customSourceDir . ${HGUILD_PROJECT_NAME}@CI
        # For at least eslint, it'll run as a different user, while the CI runs as root
        # thinlto.cache however doesnt allow read access to other users - adjust that just within CI
        - find _HGuild/Build/macOS-ARM64@Clang@@/RelWithDebInfo/${HGUILD_PROJECT_NAME}@CI -name 'thinlto.cache' -exec chmod -Rv o+rx '{}' ';'








macOS-ARM64@Clang@@~RelWithDebInfo:Package:
    only:
        - tags   # tags are stable
        - master # master branch we always want the newest ref
        # TODO? release branches. But we dont want to pickup issue branches.

    # package has no needs - requires everyone to finish the previous stages, and all tests to pass
    # we do want artifacts though from our build
    dependencies:
        - macOS-ARM64@Clang@@~RelWithDebInfo:Build
    except:
      - schedules

    artifacts:
        paths:
        - _HGuild/Build/macOS-ARM64@Clang@@/RelWithDebInfo/${HGUILD_PROJECT_NAME}@CI
            
    cache:
        key: "macOS-ARM64@Clang@@~RelWithDebInfo"
        paths:
        - _HGuild/
 
    stage: package
    tags:
        - ninja
        - osx
        - clang
        - arm64
        
    variables:
        HGUILD_PROFILE: macOS-ARM64@Clang@@
        HGUILD_BUILDTYPE: RelWithDebInfo

    before_script:
        - *hguild_before_script

    script:
        - ${HGUILD} source:install:package --buildType "${HGUILD_BUILDTYPE}" --profile "${HGUILD_PROFILE}" --customSourceDir . ${HGUILD_PROJECT_NAME}@CI build.hguildpkg
        - curl -fsSL 'https://developer.i.hackerguild.com/HGuildCI/hguildCIUpload.rb' | ruby -- - "${HGUILD_PROJECT_NAME}" "${CI_COMMIT_REF_NAME}" "${HGUILD_PROFILE}" "${HGUILD_BUILDTYPE}" build.hguildpkg
        - rm build.hguildpkg




macOS-ARM64@Clang@macOS-X86_64@~Debug:Prepare:

    except:
      - schedules

    artifacts:
        paths:
        - _HGuild/Build/macOS-ARM64@Clang@macOS-X86_64@/Debug/${HGUILD_PROJECT_NAME}@CI
        
    cache:
        key: "macOS-ARM64@Clang@macOS-X86_64@~Debug"
        paths:
        - _HGuild/
    
    stage: prepare
    tags:
        - ninja
        - osx
        - clang
        - arm64
        
    variables:
        HGUILD_PROFILE: macOS-ARM64@Clang@macOS-X86_64@
        HGUILD_BUILDTYPE: Debug

    before_script:
        - *hguild_before_script

    script:
        - ${HGUILD} install --buildType "${HGUILD_BUILDTYPE}" --profile "${HGUILD_PROFILE}" --customSourceDir . --dependenciesOnly ${HGUILD_PROJECT_NAME}@CI



macOS-ARM64@Clang@macOS-X86_64@~Debug:Build:

    except:
      - schedules

    needs:
      - macOS-ARM64@Clang@macOS-X86_64@~Debug:Prepare
    
    artifacts:
        paths:
        - _HGuild/Build/macOS-ARM64@Clang@macOS-X86_64@/Debug/${HGUILD_PROJECT_NAME}@CI
            
    cache:
        key: "macOS-ARM64@Clang@macOS-X86_64@~Debug"
        paths:
        - _HGuild/
 
    stage: build
    tags:
        - ninja
        - osx
        - clang
        - arm64
        
    variables:
        HGUILD_PROFILE: macOS-ARM64@Clang@macOS-X86_64@
        HGUILD_BUILDTYPE: Debug

    before_script:
        - *hguild_before_script

    script:
        - ${HGUILD} install --buildType "${HGUILD_BUILDTYPE}" --profile "${HGUILD_PROFILE}" --customSourceDir . ${HGUILD_PROJECT_NAME}@CI
        # For at least eslint, it'll run as a different user, while the CI runs as root
        # thinlto.cache however doesnt allow read access to other users - adjust that just within CI
        - find _HGuild/Build/macOS-ARM64@Clang@macOS-X86_64@/Debug/${HGUILD_PROJECT_NAME}@CI -name 'thinlto.cache' -exec chmod -Rv o+rx '{}' ';'








macOS-ARM64@Clang@macOS-X86_64@~Debug:Package:
    only:
        - tags   # tags are stable
        - master # master branch we always want the newest ref
        # TODO? release branches. But we dont want to pickup issue branches.

    # package has no needs - requires everyone to finish the previous stages, and all tests to pass
    # we do want artifacts though from our build
    dependencies:
        - macOS-ARM64@Clang@macOS-X86_64@~Debug:Build
    except:
      - schedules

    artifacts:
        paths:
        - _HGuild/Build/macOS-ARM64@Clang@macOS-X86_64@/Debug/${HGUILD_PROJECT_NAME}@CI
            
    cache:
        key: "macOS-ARM64@Clang@macOS-X86_64@~Debug"
        paths:
        - _HGuild/
 
    stage: package
    tags:
        - ninja
        - osx
        - clang
        - arm64
        
    variables:
        HGUILD_PROFILE: macOS-ARM64@Clang@macOS-X86_64@
        HGUILD_BUILDTYPE: Debug

    before_script:
        - *hguild_before_script

    script:
        - ${HGUILD} source:install:package --buildType "${HGUILD_BUILDTYPE}" --profile "${HGUILD_PROFILE}" --customSourceDir . ${HGUILD_PROJECT_NAME}@CI build.hguildpkg
        - curl -fsSL 'https://developer.i.hackerguild.com/HGuildCI/hguildCIUpload.rb' | ruby -- - "${HGUILD_PROJECT_NAME}" "${CI_COMMIT_REF_NAME}" "${HGUILD_PROFILE}" "${HGUILD_BUILDTYPE}" build.hguildpkg
        - rm build.hguildpkg




macOS-ARM64@Clang@macOS-X86_64@~RelWithDebInfo:Prepare:

    except:
      - schedules

    artifacts:
        paths:
        - _HGuild/Build/macOS-ARM64@Clang@macOS-X86_64@/RelWithDebInfo/${HGUILD_PROJECT_NAME}@CI
        
    cache:
        key: "macOS-ARM64@Clang@macOS-X86_64@~RelWithDebInfo"
        paths:
        - _HGuild/
    
    stage: prepare
    tags:
        - ninja
        - osx
        - clang
        - arm64
        
    variables:
        HGUILD_PROFILE: macOS-ARM64@Clang@macOS-X86_64@
        HGUILD_BUILDTYPE: RelWithDebInfo

    before_script:
        - *hguild_before_script

    script:
        - ${HGUILD} install --buildType "${HGUILD_BUILDTYPE}" --profile "${HGUILD_PROFILE}" --customSourceDir . --dependenciesOnly ${HGUILD_PROJECT_NAME}@CI



macOS-ARM64@Clang@macOS-X86_64@~RelWithDebInfo:Build:

    except:
      - schedules

    needs:
      - macOS-ARM64@Clang@macOS-X86_64@~RelWithDebInfo:Prepare
    
    artifacts:
        paths:
        - _HGuild/Build/macOS-ARM64@Clang@macOS-X86_64@/RelWithDebInfo/${HGUILD_PROJECT_NAME}@CI
            
    cache:
        key: "macOS-ARM64@Clang@macOS-X86_64@~RelWithDebInfo"
        paths:
        - _HGuild/
 
    stage: build
    tags:
        - ninja
        - osx
        - clang
        - arm64
        
    variables:
        HGUILD_PROFILE: macOS-ARM64@Clang@macOS-X86_64@
        HGUILD_BUILDTYPE: RelWithDebInfo

    before_script:
        - *hguild_before_script

    script:
        - ${HGUILD} install --buildType "${HGUILD_BUILDTYPE}" --profile "${HGUILD_PROFILE}" --customSourceDir . ${HGUILD_PROJECT_NAME}@CI
        # For at least eslint, it'll run as a different user, while the CI runs as root
        # thinlto.cache however doesnt allow read access to other users - adjust that just within CI
        - find _HGuild/Build/macOS-ARM64@Clang@macOS-X86_64@/RelWithDebInfo/${HGUILD_PROJECT_NAME}@CI -name 'thinlto.cache' -exec chmod -Rv o+rx '{}' ';'








macOS-ARM64@Clang@macOS-X86_64@~RelWithDebInfo:Package:
    only:
        - tags   # tags are stable
        - master # master branch we always want the newest ref
        # TODO? release branches. But we dont want to pickup issue branches.

    # package has no needs - requires everyone to finish the previous stages, and all tests to pass
    # we do want artifacts though from our build
    dependencies:
        - macOS-ARM64@Clang@macOS-X86_64@~RelWithDebInfo:Build
    except:
      - schedules

    artifacts:
        paths:
        - _HGuild/Build/macOS-ARM64@Clang@macOS-X86_64@/RelWithDebInfo/${HGUILD_PROJECT_NAME}@CI
            
    cache:
        key: "macOS-ARM64@Clang@macOS-X86_64@~RelWithDebInfo"
        paths:
        - _HGuild/
 
    stage: package
    tags:
        - ninja
        - osx
        - clang
        - arm64
        
    variables:
        HGUILD_PROFILE: macOS-ARM64@Clang@macOS-X86_64@
        HGUILD_BUILDTYPE: RelWithDebInfo

    before_script:
        - *hguild_before_script

    script:
        - ${HGUILD} source:install:package --buildType "${HGUILD_BUILDTYPE}" --profile "${HGUILD_PROFILE}" --customSourceDir . ${HGUILD_PROJECT_NAME}@CI build.hguildpkg
        - curl -fsSL 'https://developer.i.hackerguild.com/HGuildCI/hguildCIUpload.rb' | ruby -- - "${HGUILD_PROJECT_NAME}" "${CI_COMMIT_REF_NAME}" "${HGUILD_PROFILE}" "${HGUILD_BUILDTYPE}" build.hguildpkg
        - rm build.hguildpkg



Scheduler:
    only:
      - schedules
      
    image: docker.i.hackerguild.com/hackerguild/hackerguild-gitlabci-docker:latest

    cache:
        key: "Linux-X86_64@Clang@@~Debug"
        paths:
        - _HGuild/
 
    stage: build
    tags:
        - linux
        - docker
        - x86_64
        
    variables:
        HGUILD_PROFILE: Linux-X86_64@Clang@@
        HGUILD_BUILDTYPE: Debug
        HGUILD_SOURCENAME: libWexpr@CI

    before_script:
        - *hguild_before_script
    
    script:
      - Support/gitlabScheduler.rb

